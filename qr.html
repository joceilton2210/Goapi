<!DOCTYPE html>

<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    
    <!-- SEO Meta Tags -->
    <title>Conectar Inst√¢ncia WhatsApp - GO API WhatsApp Manager</title>
    <meta name="description" content="Conecte sua inst√¢ncia do WhatsApp √† GO API. Gerencie mensagens, automa√ß√µes e integra√ß√µes de forma profissional e segura. QR Code r√°pido e f√°cil.">
    <meta name="keywords" content="WhatsApp API, GO API, conectar WhatsApp, inst√¢ncia WhatsApp, QR Code WhatsApp, automa√ß√£o WhatsApp, API mensagens">
    <meta name="author" content="Time GO - Nakamura, Joceilton Gomes, Othon Righetti">
    <meta name="robots" content="index, follow">
    <meta name="language" content="pt-BR">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="qr.html">
    <meta property="og:title" content="Conectar Inst√¢ncia WhatsApp - GO API">
    <meta property="og:description" content="Conecte sua inst√¢ncia do WhatsApp √† GO API. Gerencie mensagens e automa√ß√µes de forma profissional.">
    <meta property="og:image" content="logo.png">
    <meta property="og:site_name" content="GO API WhatsApp">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="qr.html">
    <meta name="twitter:title" content="Conectar Inst√¢ncia WhatsApp - GO API">
    <meta name="twitter:description" content="Conecte sua inst√¢ncia do WhatsApp √† GO API. Gerencie mensagens e automa√ß√µes de forma profissional.">
    <meta name="twitter:image" content="logo.png">
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" sizes="32x32" href="logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
    <link rel="shortcut icon" href="logo.png" type="image/x-icon">
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Global Config -->
    <script src="assets/js/config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- Custom Alert System -->
    <script src="assets/js/alert.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#eaa800",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
</head>

<body class="font-display bg-gray-50 dark:bg-background-dark text-slate-900 dark:text-white overflow-x-hidden">
    <div class="relative flex h-auto min-h-screen w-full flex-col group/design-root">
        <!-- Top Navigation Bar -->
         <!-- Top Navigation -->
    <header
        class="border-b border-solid border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark sticky top-0 z-50">
        <div class="flex items-center justify-center py-3 px-4 md:px-10 lg:px-20">
            <div class="flex items-center justify-between w-full max-w-[1200px]">
                <div class="flex items-center gap-6 text-slate-900 dark:text-white">
                    <img src="logo_black.png" alt="GO API Logo" class="h-12 w-auto object-contain dark:hidden">
                    <img src="logo_white.png" alt="GO API Logo" class="h-12 w-auto object-contain hidden dark:block">
                    <a href="instancia.html"
                        class="hidden md:block text-text-secondary-light dark:text-text-secondary-dark hover:text-white transition-colors text-sm font-medium">
                        Dashboard
                    </a>
                    <a href="documentacao.html"
                        class="hidden md:block text-primary font-semibold text-sm">
                        Documenta√ß√£o
                    </a>
                    <a href="integracao.html"
                        class="hidden md:block text-text-secondary-light dark:text-text-secondary-dark hover:text-white transition-colors text-sm font-medium">
                        Integra√ß√£o
                    </a>
                    <a href="envio.html"
                        class="hidden md:block text-primary font-semibold text-sm">
                        Enviar Mensagens
                    </a>
                </div>
                <div class="flex gap-6 items-center">
                    <button id="theme-toggle"
                        class="text-text-secondary-light dark:text-text-secondary-dark hover:text-white transition-colors">
                        <span class="material-symbols-outlined dark:hidden">light_mode</span>
                        <span class="material-symbols-outlined hidden dark:inline">dark_mode</span>
                    </button>
                    <!-- Language Dropdown -->
                    <div class="relative">
                        <button id="language-toggle"
                            class="flex items-center gap-2 px-3 py-1.5 text-text-secondary-light dark:text-text-secondary-dark hover:text-white transition-colors text-sm font-semibold rounded-lg hover:bg-surface-dark">
                            <span class="material-symbols-outlined text-[18px]">language</span>
                            <span id="current-lang-text">PT</span>
                            <span class="material-symbols-outlined text-[14px]">expand_more</span>
                        </button>
                        
                        <!-- Dropdown Menu -->
                        <div id="language-dropdown"
                            class="hidden absolute top-full right-0 mt-2 w-44 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-xl overflow-hidden z-50">
                            <button onclick="selectLanguage('pt')"
                                class="w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
                                <span><img src="bra.png" alt="Bandeira Brasil" class="w-5 h-5 object-cover rounded"></span>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Portugu√™s</span>
                            </button>
                            <button onclick="selectLanguage('en')"
                                class="w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
                                <span><img src="usa.png" alt="Bandeira EUA" class="w-5 h-5 object-cover rounded"></span>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-200">English</span>
                            </button>
                            <button onclick="selectLanguage('es')"
                                class="w-full flex items-center gap-2 px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-left">
                                <span><img src="esp.png" alt="Bandeira Espanha" class="w-5 h-5 object-cover rounded"></span>
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-200">Espa√±ol</span>
                            </button>
                        </div>
                    </div>
                    <div class="h-8 w-[1px] bg-border-light dark:bg-border-dark"></div>
                    <div class="flex items-center gap-3">
                        <div class="text-right hidden sm:block">
                            <p id="user-name" class="text-sm font-semibold">Usu√°rio</p>
                            <p class="text-xs text-text-secondary-light dark:text-text-secondary-dark">GO API</p>
                        </div>
                        <div class="bg-center bg-no-repeat bg-cover rounded-full size-10 border-2 border-primary"
                            data-alt="User profile picture placeholder"
                            style='background-image: url("icone.png");'>
                        </div>
                        <button id="logout-btn" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors">
                            <span class="material-symbols-outlined text-[18px]">logout</span>
                            <span class="hidden sm:inline">Sair</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
        <div class="layout-container flex h-full grow flex-col">
            <div class="px-4 md:px-10 lg:px-40 flex flex-1 justify-center py-10">
                <div class="layout-content-container flex flex-col max-w-[1200px] flex-1">
                    <!-- Page Heading -->
                    <div class="flex flex-wrap justify-between gap-3 p-4 mb-4">
                        <div class="flex min-w-72 flex-col gap-3">
                            <div class="flex items-center gap-3">
                                <h1
                                    class="text-slate-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]" data-i18n="page-title">
                                    Connect Instance #42</h1>
                                <span
                                    class="px-3 py-1 bg-yellow-500/10 text-yellow-600 dark:text-yellow-400 rounded-full text-xs font-bold border border-yellow-500/20" data-i18n="status-badge">Disconnected</span>
                            </div>
                            <p class="text-slate-600 dark:text-slate-300 text-base font-normal leading-normal" data-i18n="page-subtitle">
                                Scan the QR code below to link your WhatsApp account to this API instance.
                            </p>
                        </div>
                    </div>
                    <!-- Main Content Area: Instructions + QR Code -->
                    <div class="p-4">
                        <div
                            class="flex flex-col lg:flex-row gap-8 items-start bg-white dark:bg-[#192233] rounded-xl shadow-sm border border-gray-200 dark:border-[#232f48] p-8 lg:p-12">
                            <!-- Left Column: Instructions -->
                            <div class="flex flex-1 flex-col gap-8">
                                <div class="flex flex-col gap-2">
                                    <h2 class="text-slate-900 dark:text-white text-2xl font-bold leading-tight" data-i18n="instructions-title">
                                        Instructions</h2>
                                    <p class="text-slate-600 dark:text-slate-300 text-base" data-i18n="instructions-subtitle">Follow these steps on your
                                        mobile device:</p>
                                </div>
                                <div class="flex flex-col gap-6">
                                    <div class="flex gap-4 items-start">
                                        <span
                                            class="flex items-center justify-center size-8 rounded-full bg-primary/10 text-primary font-bold text-sm shrink-0">1</span>
                                        <div class="flex flex-col gap-1">
                                            <p
                                                class="text-slate-900 dark:text-white text-base font-medium leading-normal" data-i18n="step1-title">
                                                Open WhatsApp</p>
                                            <p
                                                class="text-slate-600 dark:text-slate-300 text-sm font-normal leading-normal" data-i18n="step1-desc">
                                                Open WhatsApp on your mobile phone.</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-4 items-start">
                                        <span
                                            class="flex items-center justify-center size-8 rounded-full bg-primary/10 text-primary font-bold text-sm shrink-0">2</span>
                                        <div class="flex flex-col gap-1">
                                            <p
                                                class="text-slate-900 dark:text-white text-base font-medium leading-normal" data-i18n="step2-title">
                                                Go to Settings</p>
                                            <p
                                                class="text-slate-600 dark:text-slate-300 text-sm font-normal leading-normal" data-i18n="step2-desc">
                                                Tap <span class="font-bold">Menu</span> on Android or <span
                                                    class="font-bold">Settings</span> on iOS.</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-4 items-start">
                                        <span
                                            class="flex items-center justify-center size-8 rounded-full bg-primary/10 text-primary font-bold text-sm shrink-0">3</span>
                                        <div class="flex flex-col gap-1">
                                            <p
                                                class="text-slate-900 dark:text-white text-base font-medium leading-normal" data-i18n="step3-title">
                                                Select Linked Devices</p>
                                            <p
                                                class="text-slate-600 dark:text-slate-300 text-sm font-normal leading-normal" data-i18n="step3-desc">
                                                Tap on <span class="font-bold">Linked Devices</span> and then <span
                                                    class="font-bold">Link a Device</span>.</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-4 items-start">
                                        <span
                                            class="flex items-center justify-center size-8 rounded-full bg-primary/10 text-primary font-bold text-sm shrink-0">4</span>
                                        <div class="flex flex-col gap-1">
                                            <p
                                                class="text-slate-900 dark:text-white text-base font-medium leading-normal" data-i18n="step4-title">
                                                Scan QR Code</p>
                                            <p
                                                class="text-slate-600 dark:text-slate-300 text-sm font-normal leading-normal" data-i18n="step4-desc">
                                                Point your phone at this screen to capture the code.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Right Column: QR Code Card -->
                            <div class="w-full lg:w-auto flex justify-center">
                                <div
                                    class="flex flex-col items-center gap-6 bg-[#f6f6f8] dark:bg-[#111722] p-8 rounded-xl border border-[#e5e7eb] dark:border-[#232f48] max-w-[360px] w-full shadow-inner">
                                    <div class="relative group">
                                        <!-- QR Container -->
                                        <div class="bg-white p-4 rounded-lg shadow-sm">
                                            <div id="qrcode" class="flex items-center justify-center w-[250px] h-[250px]">
                                                <div class="text-center">
                                                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-3"></div>
                                                    <p class="text-gray-600 dark:text-gray-400 text-sm">Carregando QR Code...</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-center gap-3 w-full">
                                        <div id="qr-status" class="flex items-center gap-2 text-slate-600 dark:text-slate-300">
                                            <span class="relative flex h-3 w-3">
                                                <span
                                                    class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                                                <span
                                                    class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                                            </span>
                                            <p class="text-sm font-medium">Aguardando leitura...</p>
                                        </div>
                                        <button id="reload-qr-btn"
                                            class="w-full flex cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-primary text-slate-900 text-sm font-bold leading-normal hover:bg-white hover:text-slate-900 transition-all shadow-md shadow-primary/20">
                                            <span class="material-symbols-outlined text-[18px]">refresh</span>
                                            <span class="truncate" data-i18n="reload-qr">Recarregar QR Code</span>
                                        </button>
                                        <button id="share-qr-btn"
                                            class="w-full flex cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg h-10 px-4 bg-blue-600 text-white text-sm font-bold leading-normal hover:bg-blue-700 transition-all shadow-md">
                                            <span class="material-symbols-outlined text-[18px]">share</span>
                                            <span class="truncate">Compartilhar Link</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Footer / Troubleshooting -->
                    <div class="p-4 flex flex-col items-center gap-4">
                        <div
                            class="flex items-center gap-2 text-yellow-600 dark:text-yellow-500 bg-yellow-50 dark:bg-yellow-900/20 px-4 py-2 rounded-lg border border-yellow-200 dark:border-yellow-900/30">
                            <span class="material-symbols-outlined text-sm">lightbulb</span>
                            <p class="text-sm font-medium" data-i18n="tip">Tip: Keep your phone connected to the internet.</p>
                        </div>
                        <a class="text-slate-600 dark:text-slate-300 text-sm font-normal leading-normal hover:text-primary underline decoration-1 underline-offset-4 transition-all"
                            href="#" data-i18n="help-link">
                            Need help? Check our connection troubleshooting guide.
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
  <!-- Footer Bar - Full Width -->
    <footer class="fixed bottom-0 left-0 right-0 w-full bg-gray-800 dark:bg-gray-900 border-t border-gray-700 dark:border-gray-800 py-3 z-50">
        <div class="flex items-center justify-center gap-2 text-sm text-gray-200">
            <span class="text-primary">GO API Whatsapp</span>
            <span class="group relative cursor-help">
                <span class="group-hover:hidden">Time GO</span>
                <span class="hidden group-hover:inline"><strong> Nakamura</strong> / <strong>Joceilton Gomes</strong> / <strong>Augusto Oliveira</strong> / <strong>Othon Righetti</strong></span>
            </span>
        </div>
    </footer>  

    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('theme-toggle');
        const html = document.documentElement;

        // Check for saved theme preference or default to 'dark'
        const currentTheme = localStorage.getItem('theme') || 'dark';
        html.classList.toggle('dark', currentTheme === 'dark');

        themeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const newTheme = html.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
        });

        // Language toggle functionality
        const translations = {
            'pt': {
                'page-title': 'Conectar Inst√¢ncia #42',
                'page-subtitle': 'Escaneie o c√≥digo QR abaixo para vincular sua conta do WhatsApp a esta inst√¢ncia da API.',
                'instructions-title': 'Instru√ß√µes',
                'instructions-subtitle': 'Siga estes passos no seu dispositivo m√≥vel:',
                'step1-title': 'Abrir WhatsApp',
                'step1-desc': 'Abra o WhatsApp no seu celular.',
                'step2-title': 'Ir para Configura√ß√µes',
                'step2-desc': 'Toque em <span class="font-bold">Menu</span> no Android ou <span class="font-bold">Configura√ß√µes</span> no iOS.',
                'step3-title': 'Selecionar Aparelhos Conectados',
                'step3-desc': 'Toque em <span class="font-bold">Aparelhos Conectados</span> e depois em <span class="font-bold">Conectar Aparelho</span>.',
                'step4-title': 'Escanear C√≥digo QR',
                'step4-desc': 'Aponte seu telefone para esta tela para capturar o c√≥digo.',
                'qr-title': 'C√≥digo QR',
                'status-waiting': 'Aguardando conex√£o...',
                'reload-qr': 'Recarregar QR Code',
                'tip': 'Dica: Mantenha seu telefone conectado √† internet.',
                'help-link': 'Precisa de ajuda? Confira nosso guia de solu√ß√£o de problemas de conex√£o.',
                'status-badge': 'Desconectado'
            },
            'en': {
                'page-title': 'Connect Instance #42',
                'page-subtitle': 'Scan the QR code below to link your WhatsApp account to this API instance.',
                'instructions-title': 'Instructions',
                'instructions-subtitle': 'Follow these steps on your mobile device:',
                'step1-title': 'Open WhatsApp',
                'step1-desc': 'Open WhatsApp on your mobile phone.',
                'step2-title': 'Go to Settings',
                'step2-desc': 'Tap <span class="font-bold">Menu</span> on Android or <span class="font-bold">Settings</span> on iOS.',
                'step3-title': 'Select Linked Devices',
                'step3-desc': 'Tap on <span class="font-bold">Linked Devices</span> and then <span class="font-bold">Link a Device</span>.',
                'step4-title': 'Scan QR Code',
                'step4-desc': 'Point your phone at this screen to capture the code.',
                'qr-title': 'QR Code',
                'status-waiting': 'Waiting for connection...',
                'reload-qr': 'Reload QR Code',
                'tip': 'Tip: Keep your phone connected to the internet.',
                'help-link': 'Need help? Check our connection troubleshooting guide.',
                'status-badge': 'Disconnected'
            },
            'es': {
                'page-title': 'Conectar Instancia #42',
                'page-subtitle': 'Escanea el c√≥digo QR a continuaci√≥n para vincular tu cuenta de WhatsApp a esta instancia de API.',
                'instructions-title': 'Instrucciones',
                'instructions-subtitle': 'Sigue estos pasos en tu dispositivo m√≥vil:',
                'step1-title': 'Abrir WhatsApp',
                'step1-desc': 'Abre WhatsApp en tu tel√©fono m√≥vil.',
                'step2-title': 'Ir a Configuraci√≥n',
                'step2-desc': 'Toca <span class="font-bold">Men√∫</span> en Android o <span class="font-bold">Configuraci√≥n</span> en iOS.',
                'step3-title': 'Seleccionar Dispositivos Vinculados',
                'step3-desc': 'Toca en <span class="font-bold">Dispositivos Vinculados</span> y luego en <span class="font-bold">Vincular Dispositivo</span>.',
                'step4-title': 'Escanear C√≥digo QR',
                'step4-desc': 'Apunta tu tel√©fono a esta pantalla para capturar el c√≥digo.',
                'qr-title': 'C√≥digo QR',
                'status-waiting': 'Esperando conexi√≥n...',
                'reload-qr': 'Recargar C√≥digo QR',
                'tip': 'Consejo: Mant√©n tu tel√©fono conectado a internet.',
                'help-link': '¬øNecesitas ayuda? Consulta nuestra gu√≠a de soluci√≥n de problemas de conexi√≥n.',
                'status-badge': 'Desconectado'
            }
        };

        const languageToggle = document.getElementById('language-toggle');
        const languageDropdown = document.getElementById('language-dropdown');
        const currentLangText = document.getElementById('current-lang-text');
        let currentLanguage = localStorage.getItem('language') || 'pt';

        const languageNames = {
            'pt': 'Portugu√™s',
            'en': 'English',
            'es': 'Espa√±ol'
        };

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            currentLangText.textContent = languageNames[lang];
            
            // Update all translatable elements
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    element.innerHTML = translations[lang][key];
                }
            });
            
            // Close dropdown
            languageDropdown.classList.add('hidden');
        }

        // Toggle dropdown
        languageToggle.addEventListener('click', () => {
            languageDropdown.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!languageToggle.contains(e.target) && !languageDropdown.contains(e.target)) {
                languageDropdown.classList.add('hidden');
            }
        });

        // Function to select language (called from dropdown buttons)
        function selectLanguage(lang) {
            changeLanguage(lang);
        }

        // Initialize language
        changeLanguage(currentLanguage);

        // Auth & Config
        if (!localStorage.getItem('user_token')) {
            window.location.href = 'login.html';
        }

        // Exibir nome do usu√°rio
        const userName = localStorage.getItem('user_name') || 'Usu√°rio';
        document.getElementById('user-name').textContent = userName;

        // Bot√£o de logout
        document.getElementById('logout-btn').addEventListener('click', () => {
            if (confirm('Tem certeza que deseja sair?')) {
                localStorage.removeItem('user_token');
                localStorage.removeItem('user_name');
                window.location.href = 'login.html';
            }
        });
        
        // Usar configura√ß√£o global
        const API_CONFIG = window.GO_API_CONFIG || {
            baseUrl: window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:4000/api'
                : `${window.location.protocol}//${window.location.host}/api`,
            apiKey: 'change-this-key'
        };

        // QR Code Logic
        const urlParams = new URLSearchParams(window.location.search);
        const instanceId = urlParams.get('instance');
        
        if (!instanceId) {
            showError('Inst√¢ncia n√£o especificada', 'Erro');
            setTimeout(() => {
                window.location.href = 'instancia.html';
            }, 2000);
        } else {
            document.querySelector('[data-i18n="page-title"]').textContent = `Conectar ${instanceId}`;
        }

        let qrCodeObj = null;
        let socket = null;
        let lastQRCode = null;

        // Conectar ao WebSocket
        function connectWebSocket() {
            const socketUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:4000'
                : window.location.origin;
            
            console.log('Connecting to WebSocket:', socketUrl);
            socket = io(socketUrl, {
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                console.log('‚úì WebSocket connected!');
                // Inscrever-se para receber atualiza√ß√µes desta inst√¢ncia
                socket.emit('subscribe', instanceId);
                updateQRStatus('waiting', 'Conectado ao servidor...');
            });

            socket.on('disconnect', () => {
                console.log('‚úó WebSocket disconnected');
                updateQRStatus('error', 'Conex√£o perdida. Reconectando...');
            });

            // QR Code atualizado em tempo real
            socket.on('qr:updated', (data) => {
                console.log('üì± QR Code received via WebSocket');
                renderQRCode(data.qrCode);
                updateQRStatus('waiting', 'Aguardando leitura do QR Code...');
            });

            // Status de conex√£o atualizado
            socket.on('connection:status', (data) => {
                console.log('üìä Connection status:', data.status);
                
                if (data.status === 'connecting') {
                    updateQRStatus('waiting', 'Conectando ao WhatsApp...');
                } else if (data.status === 'qr_generated') {
                    updateQRStatus('waiting', 'QR Code gerado! Escaneie agora.');
                }
            });

            // CONECTADO! Em tempo real
            socket.on('connection:success', (data) => {
                console.log('‚úì‚úì‚úì CONNECTED VIA WEBSOCKET!', data);
                updateQRStatus('connected', '‚úì WhatsApp Conectado!');
                
                showSuccess(`WhatsApp conectado!\nTelefone: ${data.phoneNumber}\nRedirecionando...`, 'Sucesso!');
                
                // Redirecionar imediatamente
                setTimeout(() => {
                    socket.emit('unsubscribe', instanceId);
                    socket.disconnect();
                    window.location.href = 'instancia.html';
                }, 1500);
            });

            // Desconectado
            socket.on('connection:disconnected', (data) => {
                console.log('‚úó Disconnected:', data.reason);
                updateQRStatus('error', 'Desconectado. Tentando reconectar...');
            });
        }

        // Renderizar QR Code
        function renderQRCode(qrCodeData) {
            if (lastQRCode === qrCodeData) return; // Evitar re-render
            lastQRCode = qrCodeData;

            const qrElement = document.getElementById('qrcode');
            if (!qrElement) return;

            qrElement.innerHTML = '';
            
            const qrCodeDiv = document.createElement('div');
            qrCodeDiv.style.position = 'relative';
            qrCodeDiv.style.display = 'inline-block';
            qrElement.appendChild(qrCodeDiv);
            
            new QRCode(qrCodeDiv, {
                text: qrCodeData,
                width: 250,
                height: 250,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            
            // Logo no centro
            setTimeout(() => {
                const logoOverlay = document.createElement('div');
                logoOverlay.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:50px;height:50px;background:white;border-radius:8px;padding:5px;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:flex;align-items:center;justify-content:center';
                
                const logo = document.createElement('img');
                logo.src = 'icone.png';
                logo.style.cssText = 'width:40px;height:40px;object-fit:contain';
                logo.alt = 'GO API';
                
                logoOverlay.appendChild(logo);
                qrCodeDiv.appendChild(logoOverlay);
            }, 100);
        }

        // Buscar QR inicial (fallback)
        async function fetchInitialQR() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/instances/${instanceId}/qr`, {
                    headers: { 'x-api-key': API_CONFIG.apiKey }
                });
                const data = await response.json();

                if (data.success && data.data && data.data.qrCode) {
                    renderQRCode(data.data.qrCode);
                    updateQRStatus('waiting', 'Aguardando leitura do QR Code...');
                }
            } catch (error) {
                console.error('Error fetching initial QR:', error);
            }
        }

        // Fun√ß√£o para compartilhar link
        function shareQRLink() {
            const shareUrl = `${window.location.origin}/qr-share.html?instance=${encodeURIComponent(instanceId)}`;
            
            // Tentar usar a API de compartilhamento nativa
            if (navigator.share) {
                navigator.share({
                    title: 'Conectar WhatsApp - GO API',
                    text: `Conecte a inst√¢ncia ${instanceId} ao WhatsApp`,
                    url: shareUrl
                }).then(() => {
                    showSuccess('Link compartilhado com sucesso!');
                }).catch((error) => {
                    if (error.name !== 'AbortError') {
                        copyToClipboard(shareUrl);
                    }
                });
            } else {
                // Fallback: copiar para clipboard
                copyToClipboard(shareUrl);
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showSuccess('Link copiado para a √°rea de transfer√™ncia!', 'Sucesso');
                }).catch(() => {
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showSuccess('Link copiado para a √°rea de transfer√™ncia!', 'Sucesso');
            } catch (err) {
                showError('N√£o foi poss√≠vel copiar o link', 'Erro');
            }
            document.body.removeChild(textArea);
        }

        // Atualizar status visual
        function updateQRStatus(status, message) {
            const statusEl = document.getElementById('qr-status');
            if (!statusEl) return;

            if (status === 'waiting') {
                statusEl.innerHTML = '<span class="relative flex h-3 w-3">' +
                    '<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>' +
                    '<span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>' +
                    '</span>' +
                    '<p class="text-sm font-medium">' + message + '</p>';
            } else if (status === 'connected') {
                statusEl.innerHTML = '<span class="relative flex h-3 w-3">' +
                    '<span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>' +
                    '</span>' +
                    '<p class="text-sm font-medium text-green-600 dark:text-green-400">' + message + '</p>';
            } else if (status === 'error') {
                statusEl.innerHTML = '<span class="relative flex h-3 w-3">' +
                    '<span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>' +
                    '</span>' +
                    '<p class="text-sm font-medium text-red-600 dark:text-red-400">' + message + '</p>';
            }
        }

        // Event listeners
        const shareBtn = document.getElementById('share-qr-btn');
        if (shareBtn) {
            shareBtn.addEventListener('click', shareQRLink);
        }

        const reloadBtn = document.getElementById('reload-qr-btn');
        if (reloadBtn) {
            reloadBtn.addEventListener('click', () => {
                updateQRStatus('waiting', 'Recarregando...');
                fetchInitialQR();
            });
        }

        // Inicializar WebSocket e buscar QR inicial
        connectWebSocket();
        fetchInitialQR();
    </script>
</body>

</html>